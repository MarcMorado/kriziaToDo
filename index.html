<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hogar Bonito - Daily Tasks</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('silent'); // Reducimos el ruido en consola

        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'mint-green': '#98FB98', 
                        'deep-rose': '#AA4A4A', 
                        'text-dark': '#1A1A1A', 
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        .card { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .scroll-container { max-height: 50vh; overflow-y: auto; }
        .complete-btn { transition: all 0.2s; transform-origin: center; }
        .complete-btn:hover:not(.completed) { transform: scale(1.05); }
        .main-container { max-width: 420px; }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(2px); }
        .delete-btn { transition: opacity 0.2s, transform 0.2s; }
        .task-delete-btn.hidden-by-admin { display: none !important; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 flex justify-center font-sans">

    <div id="loading-screen" class="fixed inset-0 bg-gray-50 flex flex-col items-center justify-center z-50">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-mint-green"></div>
        <p class="mt-4 text-lg text-text-dark">Loading your beautiful day...</p>
    </div>

    <div id="app-container" class="main-container w-full transition-opacity opacity-0 duration-500">
        <header class="text-center mb-6">
            <h1 class="text-4xl font-extrabold text-deep-rose mb-1">Hogar Bonito üå∏</h1>
            <p class="text-sm text-text-dark/70">Daily Self-Improvement</p>
            <p id="user-id-display" class="text-xs mt-2 text-text-dark/50 hidden">Session ID: ...</p>
            <button id="admin-toggle-btn" class="mt-2 text-xs text-mint-green hover:text-deep-rose transition">Admin Mode</button>
        </header>

        <div class="card bg-white p-4 rounded-xl mb-6 shadow-lg border-b-4 border-mint-green">
            <h2 class="text-xl font-bold text-text-dark mb-2 flex justify-between items-center">
                <span>Reward Progress</span>
                <span id="reward-text" class="text-deep-rose text-sm font-semibold"></span>
            </h2>
            <div class="w-full bg-gray-200 rounded-full h-3">
                <div id="progress-bar" class="h-3 rounded-full bg-mint-green transition-all duration-500" style="width: 0%"></div>
            </div>
            <p id="points-display" class="text-sm mt-2 text-text-dark text-right"></p>
        </div>
        
        <h2 class="2xl font-bold text-text-dark mb-3">Today's Tasks</h2>
        <div id="task-list-container" class="scroll-container space-y-3 pb-4">
            <p id="empty-list-message" class="text-center text-gray-500 italic mt-8 hidden">All tasks completed! Amazing job! üíñ</p>
        </div>

        <div id="admin-panel" class="card bg-white p-4 rounded-xl mt-8 shadow-inner border-t-4 border-deep-rose hidden">
            <h3 class="text-xl font-bold text-deep-rose mb-4">Admin Panel (Husband Mode)</h3>
            
            <form id="add-task-form" class="space-y-3 mb-6">
                <h4 class="font-semibold text-text-dark">Add Manual Task</h4>
                <input type="text" id="new-task-title" placeholder="Title (e.g., Kiss me)" required
                       class="w-full p-2 border border-gray-300 rounded-lg focus:ring-deep-rose focus:border-deep-rose">
                <input type="number" id="new-task-points" placeholder="Points (e.g., 50)" value="50" required
                       class="w-full p-2 border border-gray-300 rounded-lg focus:ring-deep-rose focus:border-deep-rose">
                <button type="submit" class="w-full p-2 bg-deep-rose text-white font-bold rounded-lg hover:bg-deep-rose/80 transition">
                    Add Task
                </button>
            </form>

            <div class="space-y-3">
                <h4 class="font-semibold text-text-dark">Global Settings</h4>
                <input type="number" id="reward-goal-input" placeholder="Point Goal (e.g., 1000)" required
                       class="w-full p-2 border border-gray-300 rounded-lg focus:ring-mint-green focus:border-mint-green">
                <input type="text" id="reward-text-input" placeholder="Reward Name" required
                       class="w-full p-2 border border-gray-300 rounded-lg focus:ring-mint-green focus:border-mint-green">
                <button id="update-goal-btn" class="w-full p-2 bg-mint-green text-text-dark font-bold rounded-lg hover:bg-mint-green/80 transition">
                    Update Goal
                </button>
                
                <h4 class="font-semibold text-text-dark pt-2">Force Schedule Update</h4>
                <button id="force-refresh-btn" class="w-full p-2 bg-blue-100 text-blue-800 font-bold rounded-lg hover:bg-blue-200 transition text-sm">
                    Force "Today's" Tasks (Reset)
                </button>
            </div>
        </div>
    </div>

    <div id="password-modal" class="modal-overlay fixed inset-0 flex items-center justify-center z-50 hidden transition-opacity duration-300">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-11/12 max-w-sm border-t-4 border-deep-rose">
            <h3 class="text-xl font-bold text-deep-rose mb-4">Admin Access</h3>
            <form id="password-form" class="space-y-4">
                <input type="password" id="admin-password-input" placeholder="Secret Password" required
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-mint-green focus:border-mint-green text-lg">
                <p id="password-error" class="text-red-500 text-sm hidden">Wrong password.</p>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancel-password-btn" class="px-4 py-2 text-sm text-text-dark bg-gray-200 rounded-lg">Cancel</button>
                    <button type="submit" class="px-4 py-2 text-sm text-white bg-deep-rose font-semibold rounded-lg">Login</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // === CONFIGURACI√ìN ===
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyCYktJzpk3JHHWu3CZ-nLEN2TBQUijQO0s",
            authDomain: "studio-395727845-bd961.firebaseapp.com",
            projectId: "studio-395727845-bd961",
            storageBucket: "studio-395727845-bd961.firebasestorage.app",
            messagingSenderId: "670223542551",
            appId: "1:670223542551:web:411fc2bf311d2459fc2f52"
        };

        const ADMIN_PASSWORD = "maridopoderoso"; 
        const RESET_HOUR = 7; // Hora a la que se reinicia el d√≠a (7 AM)

        // === CALENDARIO SEMANAL (EN INGL√âS) ===
        // 0=Sunday, 1=Monday, ... 6=Saturday
        const WEEKLY_SCHEDULE = {
            1: [ // Monday (Lunes)
                { t: "Go to the gym", p: 10 },
                { t: "Make the bed", p: 5 },
                { t: "Start the washing machine", p: 8 },
                { t: "Massage", p: 10 },
                { t: "Hang out the laundry", p: 8 }
            ],
            2: [ // Tuesday (Martes)
                { t: "Go for a run", p: 10 },
                { t: "Fold dried clothes", p: 8 },
                { t: "Help me clean the house", p: 15 }
            ],
            3: [ // Wednesday (Miercoles)
                { t: "Go to the gym", p: 10 },
                { t: "Send me a nice photo", p: 2 },
                { t: "Work", p: 5 },
                { t: "Make dinner", p: 8 },
                { t: "Start the washing machine", p: 8 },
                { t: "Hang out the laundry", p: 8 }
            ],
            4: [ // Thursday (Jueves)
                { t: "Go for a run", p: 10 },
                { t: "Fold dried clothes", p: 8 },
                { t: "Send me a cute photo", p: 2 },
                { t: "Work", p: 5 },
                { t: "Make dinner", p: 8 }
            ],
            5: [ // Friday (Viernes)
                { t: "Go to the gym", p: 10 },
                { t: "Send me a nice photo", p: 2 },
                { t: "Work", p: 5 },
                { t: "Make dinner", p: 8 }
            ],
            6: [ // Saturday (Tu segundo 'Miercoles')
                { t: "Send me a nice photo", p: 2 },
                { t: "Work", p: 5 },
                { t: "Make dinner", p: 8 },
                { t: "Start the washing machine", p: 8 },
                { t: "Hang out the laundry", p: 8 }
            ],
            0: [ // Sunday (Domingo)
                { t: "Fold clothes", p: 8 },
                { t: "Long massage", p: 25 }
            ]
        };

        let db, auth, configDocRef;
        let isAdminMode = false;

        // Elementos DOM
        const els = {
            loading: document.getElementById('loading-screen'),
            app: document.getElementById('app-container'),
            list: document.getElementById('task-list-container'),
            empty: document.getElementById('empty-list-message'),
            rewardGoal: document.getElementById('reward-goal-input'),
            rewardText: document.getElementById('reward-text-input'),
            progressBar: document.getElementById('progress-bar'),
            points: document.getElementById('points-display'),
            rewardLabel: document.getElementById('reward-text'),
            adminPanel: document.getElementById('admin-panel'),
            modal: document.getElementById('password-modal'),
            passInput: document.getElementById('admin-password-input'),
            passError: document.getElementById('password-error')
        };

        async function init() {
            try {
                const app = initializeApp(FIREBASE_CONFIG);
                db = getFirestore(app);
                auth = getAuth(app);
                await signInAnonymously(auth);
                
                configDocRef = doc(db, `/artifacts/${FIREBASE_CONFIG.projectId}/public/data/daily_tasks/`, 'main_config');
                
                // 1. Verificar configuraci√≥n inicial
                await checkAndSetInitialConfig();

                // 2. L√≥gica M√°gica: Actualizar tareas si es un nuevo d√≠a > 7AM
                await checkDailyRefresh();

                // 3. Escuchar cambios
                onSnapshot(configDocRef, (snap) => {
                    if (snap.exists()) render(snap.data());
                });

                // Quitar loading
                setTimeout(() => {
                    els.loading.classList.add('opacity-0', 'pointer-events-none');
                    els.app.classList.remove('opacity-0');
                }, 500);

            } catch (e) {
                console.error(e);
                els.loading.innerHTML = '<p class="text-red-500">Error loading app</p>';
            }
        }

        // --- L√ìGICA DE ACTUALIZACI√ìN DIARIA ---
        async function checkDailyRefresh(force = false) {
            const snap = await getDoc(configDocRef);
            if (!snap.exists()) return;

            const data = snap.data();
            const now = new Date();
            
            // Calculamos la "Fecha Virtual". 
            // Si son las 6:00 AM del Martes, para nosotros sigue siendo Lunes (no actualizamos).
            // Si son las 7:01 AM del Martes, ya es Martes.
            const virtualDate = new Date(now);
            if (now.getHours() < RESET_HOUR) {
                virtualDate.setDate(virtualDate.getDate() - 1);
            }
            
            // Cadena formato "YYYY-MM-DD"
            const dateString = virtualDate.toISOString().split('T')[0];
            const storedDate = data.last_updated_date || "";

            // Si la fecha guardada es distinta a la de hoy (despues de las 7am), actualizamos
            if (dateString !== storedDate || force) {
                console.log("Detectado nuevo d√≠a (o forzado). Actualizando tareas...");
                
                // Obtener d√≠a de la semana (0-6)
                // Ojo: Si son las 6AM, virtualDate es ayer, cargar√° tareas de ayer si no estaban cargadas.
                // Si son las 8AM, virtualDate es hoy.
                const dayOfWeek = virtualDate.getDay(); 
                const dailyTasksRaw = WEEKLY_SCHEDULE[dayOfWeek] || [];

                // Convertir al formato de objetos con ID
                const newTasks = dailyTasksRaw.map(item => ({
                    id: crypto.randomUUID(),
                    title: item.t,
                    timeframe: "Today", // Simplificado para ingl√©s
                    points: item.p,
                    completed: false
                }));

                await updateDoc(configDocRef, {
                    tasks: newTasks,
                    last_updated_date: dateString
                });
            }
        }

        async function checkAndSetInitialConfig() {
            const snap = await getDoc(configDocRef);
            if (!snap.exists()) {
                await setDoc(configDocRef, {
                    tasks: [],
                    current_points: 0,
                    reward_goal: 1000,
                    reward_name: "Family Dinner",
                    last_updated_date: "1970-01-01" // Fecha muy vieja para forzar update
                });
            }
        }

        function render(data) {
            // Progreso
            const pct = Math.min(100, (data.current_points / data.reward_goal) * 100);
            els.progressBar.style.width = `${pct}%`;
            els.points.innerText = `${data.current_points} / ${data.reward_goal} pts`;
            els.rewardLabel.innerText = data.reward_name;

            // Admin inputs
            if(isAdminMode) {
                els.rewardGoal.value = data.reward_goal;
                els.rewardText.value = data.reward_name;
            }

            // Tareas
            els.list.innerHTML = '';
            if (!data.tasks || data.tasks.length === 0) {
                els.empty.classList.remove('hidden');
            } else {
                els.empty.classList.add('hidden');
                data.tasks.forEach(task => {
                    const div = document.createElement('div');
                    div.className = "card flex items-center justify-between p-4 rounded-xl bg-white hover:bg-gray-50 transition-all";
                    
                    // Bot√≥n Eliminar (Solo Admin)
                    const delBtn = isAdminMode ? 
                        `<button onclick="window.deleteTask('${task.id}')" class="delete-btn p-1 ml-2 text-deep-rose hover:bg-red-100 rounded-full">üóëÔ∏è</button>` : '';

                    div.innerHTML = `
                        <div class="flex-1 min-w-0 mr-4">
                            <h4 class="font-semibold text-text-dark text-lg">${task.title}</h4>
                            <p class="text-xs font-mono mt-1 text-deep-rose/80">+${task.points} pts</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            ${delBtn}
                            <button onclick="window.completeTask('${task.id}')" class="complete-btn flex items-center justify-center w-10 h-10 rounded-full text-white font-bold bg-mint-green hover:bg-[#008080] shadow-md">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>
                            </button>
                        </div>
                    `;
                    els.list.appendChild(div);
                });
            }
        }

        // --- FUNCIONES GLOBALES (Window) ---
        
        // Completar = Sumar puntos + Borrar tarea
        window.completeTask = async (id) => {
            const snap = await getDoc(configDocRef);
            if (!snap.exists()) return;
            const d = snap.data();
            const task = d.tasks.find(t => t.id === id);
            if (!task) return;

            const newPoints = d.current_points + parseInt(task.points);
            const newTasks = d.tasks.filter(t => t.id !== id);

            await updateDoc(configDocRef, { tasks: newTasks, current_points: newPoints });
        };

        window.deleteTask = async (id) => {
            if (!isAdminMode) return;
            const snap = await getDoc(configDocRef);
            const newTasks = snap.data().tasks.filter(t => t.id !== id);
            await updateDoc(configDocRef, { tasks: newTasks });
        };

        // --- EVENTOS DE INTERFAZ ---

        document.getElementById('add-task-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('new-task-title').value;
            const points = parseInt(document.getElementById('new-task-points').value);
            
            const snap = await getDoc(configDocRef);
            const currentTasks = snap.data().tasks || [];
            await updateDoc(configDocRef, {
                tasks: [...currentTasks, { id: crypto.randomUUID(), title, timeframe: 'Manual', points, completed: false }]
            });
            e.target.reset();
        });

        document.getElementById('update-goal-btn').addEventListener('click', async () => {
            const goal = parseInt(els.rewardGoal.value);
            const name = els.rewardText.value;
            if(goal && name) await updateDoc(configDocRef, { reward_goal: goal, reward_name: name });
        });

        document.getElementById('force-refresh-btn').addEventListener('click', async () => {
             if(confirm("Are you sure? This will delete current pending tasks and load today's schedule.")) {
                 await checkDailyRefresh(true);
             }
        });

        // Toggle Admin
        document.getElementById('admin-toggle-btn').addEventListener('click', () => {
            if (isAdminMode) {
                isAdminMode = false;
                els.adminPanel.classList.add('hidden');
                document.getElementById('admin-toggle-btn').innerText = "Admin Mode";
                render(currentDataCache); // Re-render para ocultar botones borrar
            } else {
                els.modal.classList.remove('hidden');
                els.passInput.value = '';
                els.passInput.focus();
            }
        });

        // Password logic
        document.getElementById('password-form').addEventListener('submit', (e) => {
            e.preventDefault();
            if (els.passInput.value === ADMIN_PASSWORD) {
                isAdminMode = true;
                els.modal.classList.add('hidden');
                els.passError.classList.add('hidden');
                els.adminPanel.classList.remove('hidden');
                document.getElementById('admin-toggle-btn').innerText = "Exit Admin";
                // Forzar re-lectura para actualizar UI
                getDoc(configDocRef).then(s => render(s.data()));
            } else {
                els.passError.classList.remove('hidden');
            }
        });

        document.getElementById('cancel-password-btn').addEventListener('click', () => {
            els.modal.classList.add('hidden');
            els.passError.classList.add('hidden');
        });

        let currentDataCache = {}; 
        onSnapshot(configDocRef, (s) => { if(s.exists()) { currentDataCache = s.data(); render(s.data()); } });

        init();
    </script>
</body>
</html>
