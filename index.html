<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hogar Bonito - Tareas Diarias</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Incluir Firebase (solo la versi칩n 11.6.1 por mandato) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Establecer nivel de log para depuraci칩n de Firestore
        setLogLevel('debug');

        // Configuraci칩n de Colores y Estilos
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'mint-green': '#98FB98', // Verde Menta Principal
                        'deep-rose': '#AA4A4A',  // Burdeos/Rosa Intenso
                        'text-dark': '#1A1A1A',  // Negro Suave
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        /* Estilos personalizados para el toque 'afeminado' */
        .card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .scroll-container {
            /* Asegura que la lista sea desplazable en pantallas peque침as (m칩vil) */
            max-height: 50vh; 
            overflow-y: auto;
        }

        /* Estilo para el bot칩n de completar */
        .complete-btn {
            transition: all 0.2s;
            transform-origin: center;
        }

        .complete-btn:hover:not(.completed) {
            transform: scale(1.05);
        }
        
        /* Estilo para el contenedor principal para centrar en el m칩vil */
        .main-container {
            max-width: 420px; /* Ancho t칤pico de un iPhone 15 */
        }

        /* Estilos del Modal de Contrase침a */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(2px);
        }

        .delete-btn {
            transition: opacity 0.2s, transform 0.2s;
        }

        /* Clase para ocultar los botones de eliminar para el usuario no-admin */
        .task-delete-btn.hidden-by-admin {
            display: none !important;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 flex justify-center font-sans">

    <!-- PANTALLA DE CARGA -->
    <div id="loading-screen" class="fixed inset-0 bg-gray-50 flex flex-col items-center justify-center z-50">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-mint-green"></div>
        <p class="mt-4 text-lg text-text-dark">Cargando la lista de tareas...</p>
    </div>

    <div id="app-container" class="main-container w-full transition-opacity opacity-0 duration-500">
        <!-- T칈TULO Y USUARIO -->
        <header class="text-center mb-6">
            <h1 class="text-4xl font-extrabold text-deep-rose mb-1">Hogar Bonito 游꺚</h1>
            <p class="text-sm text-text-dark/70">Tu lista de superaci칩n diaria</p>
            <p id="user-id-display" class="text-xs mt-2 text-text-dark/50 hidden">ID de Sesi칩n: ...</p>
            <button id="admin-toggle-btn" class="mt-2 text-xs text-mint-green hover:text-deep-rose transition">Modo Admin</button>
        </header>

        <!-- BARRA DE PROGRESI칍N Y RECOMPENSA -->
        <div class="card bg-white p-4 rounded-xl mb-6 shadow-lg border-b-4 border-mint-green">
            <h2 class="text-xl font-bold text-text-dark mb-2 flex justify-between items-center">
                <span>Progreso de Recompensa</span>
                <span id="reward-text" class="text-deep-rose text-sm font-semibold"></span>
            </h2>
            <div class="w-full bg-gray-200 rounded-full h-3">
                <div id="progress-bar" class="h-3 rounded-full bg-mint-green transition-all duration-500" style="width: 0%"></div>
            </div>
            <p id="points-display" class="text-sm mt-2 text-text-dark text-right"></p>
        </div>
        
        <!-- LISTA DE TAREAS PENDIENTES -->
        <h2 class="2xl font-bold text-text-dark mb-3">Tareas de Hoy</h2>
        <div id="task-list-container" class="scroll-container space-y-3 pb-4">
            <!-- Las tareas se inyectar치n aqu칤 -->
            <p id="empty-list-message" class="text-center text-gray-500 italic mt-8 hidden">춰La lista de tareas est치 vac칤a! El administrador necesita agregar algunas.</p>
        </div>

        <!-- PANEL DE ADMINISTRACI칍N (Inicialmente oculto) -->
        <div id="admin-panel" class="card bg-white p-4 rounded-xl mt-8 shadow-inner border-t-4 border-deep-rose hidden">
            <h3 class="text-xl font-bold text-deep-rose mb-4">Panel de Administraci칩n (Modo Marido)</h3>
            <p class="text-xs text-text-dark/70 mb-3">Aqu칤 puedes gestionar la lista y el sistema de puntos.</p>

            <!-- FORMULARIO PARA A칌ADIR TAREA -->
            <form id="add-task-form" class="space-y-3 mb-6">
                <h4 class="font-semibold text-text-dark">A침adir Nueva Tarea</h4>
                <input type="text" id="new-task-title" placeholder="T칤tulo de la tarea (Ej: Tocar el piano)" required
                       class="w-full p-2 border border-gray-300 rounded-lg focus:ring-deep-rose focus:border-deep-rose">
                <input type="text" id="new-task-timeframe" placeholder="Marco temporal (Ej: Despu칠s de comer)"
                       class="w-full p-2 border border-gray-300 rounded-lg focus:ring-deep-rose focus:border-deep-rose">
                <input type="number" id="new-task-points" placeholder="Puntos (Ej: 50)" value="50" required
                       class="w-full p-2 border border-gray-300 rounded-lg focus:ring-deep-rose focus:border-deep-rose">
                <button type="submit" class="w-full p-2 bg-deep-rose text-white font-bold rounded-lg hover:bg-deep-rose/80 transition">
                    A침adir Tarea
                </button>
            </form>

            <!-- ACCIONES Y AJUSTES GLOBALES -->
            <div class="space-y-3">
                <h4 class="font-semibold text-text-dark">Acciones R치pidas</h4>
                <button id="reset-day-btn" class="w-full p-2 bg-gray-200 text-text-dark font-bold rounded-lg hover:bg-gray-300 transition">
                    Reiniciar D칤a (Tareas a Pendiente)
                </button>

                <h4 class="font-semibold text-text-dark pt-4">Ajustes Globales</h4>
                <input type="number" id="reward-goal-input" placeholder="Meta de Puntos (Ej: 1000)" required
                       class="w-full p-2 border border-gray-300 rounded-lg focus:ring-mint-green focus:border-mint-green">
                <input type="text" id="reward-text-input" placeholder="Nombre de la Recompensa (Ej: Masaje en pareja)" required
                       class="w-full p-2 border border-gray-300 rounded-lg focus:ring-mint-green focus:border-mint-green">
                <button id="update-goal-btn" class="w-full p-2 bg-mint-green text-text-dark font-bold rounded-lg hover:bg-mint-green/80 transition">
                    Actualizar Meta
                </button>
            </div>
        </div>
        
    </div>

    <!-- MODAL DE CONTRASE칌A -->
    <div id="password-modal" class="modal-overlay fixed inset-0 flex items-center justify-center z-50 hidden transition-opacity duration-300">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-11/12 max-w-sm border-t-4 border-deep-rose">
            <h3 class="text-xl font-bold text-deep-rose mb-4">Acceso de Administrador</h3>
            <p class="text-sm text-text-dark/70 mb-3">Introduce la contrase침a para acceder a la configuraci칩n.</p>
            <form id="password-form" class="space-y-4">
                <input type="password" id="admin-password-input" placeholder="Contrase침a secreta" required
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-mint-green focus:border-mint-green text-lg">
                <p id="password-error" class="text-red-500 text-sm hidden">Contrase침a incorrecta. Int칠ntalo de nuevo.</p>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancel-password-btn" class="px-4 py-2 text-sm text-text-dark bg-gray-200 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                    <button type="submit" class="px-4 py-2 text-sm text-white bg-deep-rose font-semibold rounded-lg hover:bg-deep-rose/80 transition">Acceder</button>
                </div>
            </form>
        </div>
    </div>


    <!-- M칍DULO DE SCRIPTS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Establecer nivel de log para depuraci칩n de Firestore
        setLogLevel('debug');
        
        // ----------------------------------------------------
        // 1. CONFIGURACI칍N FIREBASE, GLOBALES Y CONTRASE칌A
        // ----------------------------------------------------

        // === INYECCI칍N MANUAL DE LA CONFIGURACI칍N DE FIREBASE ===
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyCYktJzpk3JHHWu3CZ-nLEN2TBQUijQO0s",
            authDomain: "studio-395727845-bd961.firebaseapp.com",
            projectId: "studio-395727845-bd961",
            storageBucket: "studio-395727845-bd961.firebasestorage.app",
            messagingSenderId: "670223542551",
            appId: "1:670223542551:web:411fc2bf311d2459fc2f52"
        };
        // === FIN DE LA CONFIGURACI칍N DE FIREBASE ===

        const ADMIN_PASSWORD = "maridopoderoso"; // <--- CAMBIA ESTA CONTRASE칌A
        let isAdminMode = false; // Nuevo estado para controlar el panel
        
        // El App ID se puede sacar del projectId para crear la ruta
        const appId = FIREBASE_CONFIG.projectId; 
        
        let db;
        let auth;
        let userId = 'loading'; // ID del usuario actual (puede ser an칩nimo)
        let configDocRef; // Referencia al documento de configuraci칩n p칰blica

        // Valores por defecto
        const DEFAULT_CONFIG = {
            tasks: [
                { id: crypto.randomUUID(), title: 'Preparar el desayuno para los ni침os', timeframe: '7:30 - 8:00', points: 30, completed: false },
                { id: crypto.randomUUID(), title: 'Organizar la colada y planchar', timeframe: 'Ma침ana', points: 75, completed: false },
                { id: crypto.randomUUID(), title: 'Llamar a tu madre', timeframe: 'Tarde (16:00)', points: 50, completed: false },
                { id: crypto.randomUUID(), title: '30 minutos de ejercicio ligero', timeframe: 'Mediod칤a', points: 60, completed: false },
            ],
            current_points: 0,
            reward_goal: 1000,
            reward_name: "Cena en el restaurante favorito de la familia",
            points_per_task_default: 50
        };

        const elements = {
            loadingScreen: document.getElementById('loading-screen'),
            appContainer: document.getElementById('app-container'),
            userIdDisplay: document.getElementById('user-id-display'),
            rewardText: document.getElementById('reward-text'),
            progressBar: document.getElementById('progress-bar'),
            pointsDisplay: document.getElementById('points-display'),
            taskListContainer: document.getElementById('task-list-container'),
            emptyListMessage: document.getElementById('empty-list-message'),
            adminToggleBtn: document.getElementById('admin-toggle-btn'),
            adminPanel: document.getElementById('admin-panel'),
            addTaskForm: document.getElementById('add-task-form'),
            newTaskTitle: document.getElementById('new-task-title'),
            newTaskTimeframe: document.getElementById('new-task-timeframe'),
            newTaskPoints: document.getElementById('new-task-points'),
            rewardGoalInput: document.getElementById('reward-goal-input'),
            rewardTextInput: document.getElementById('reward-text-input'),
            updateGoalBtn: document.getElementById('update-goal-btn'),
            resetDayBtn: document.getElementById('reset-day-btn'), // Nuevo bot칩n
            
            // Elementos del Modal de Contrase침a
            passwordModal: document.getElementById('password-modal'),
            passwordForm: document.getElementById('password-form'),
            adminPasswordInput: document.getElementById('admin-password-input'),
            passwordError: document.getElementById('password-error'),
            cancelPasswordBtn: document.getElementById('cancel-password-btn'),
        };

        // ----------------------------------------------------
        // 2. FUNCIONES DE UTILIDAD FIREBASE
        // ----------------------------------------------------

        /**
         * Inicializa Firebase y realiza la autenticaci칩n (an칩nima para simplificar).
         */
        async function initializeFirebase() {
            try {
                const app = initializeApp(FIREBASE_CONFIG);
                db = getFirestore(app);
                auth = getAuth(app);

                // Autenticaci칩n an칩nima: permite que cualquier persona acceda y escriba
                await signInAnonymously(auth);
                
                userId = auth.currentUser.uid;
                elements.userIdDisplay.textContent = `ID de Sesi칩n: ${userId}`;
                elements.userIdDisplay.classList.remove('hidden');

                // RUTAS DE DATOS: Asegura la compatibilidad con el entorno Canvas
                // Usamos una ruta p칰blica compartida para que ambos usuarios vean y actualicen la misma lista
                // La ruta es: /artifacts/{projectId}/public/data/daily_tasks/main_config
                configDocRef = doc(db, `/artifacts/${appId}/public/data/daily_tasks/`, 'main_config');
                
                await checkAndSetInitialConfig();

                // 3. INICIAR ESCUCHA DE CAMBIOS EN TIEMPO REAL
                setupRealtimeListener();

            } catch (error) {
                console.error("Error al inicializar o autenticar Firebase:", error);
                elements.loadingScreen.innerHTML = '<p class="text-red-600">Error al cargar la aplicaci칩n. Revisa la consola.</p>';
            } finally {
                // Ocultar pantalla de carga
                setTimeout(() => {
                    elements.loadingScreen.classList.add('opacity-0', 'pointer-events-none');
                    elements.appContainer.classList.remove('opacity-0');
                }, 500);
            }
        }

        /**
         * Verifica si existe la configuraci칩n inicial, si no, la crea.
         */
        async function checkAndSetInitialConfig() {
            try {
                const docSnap = await getDoc(configDocRef);
                if (!docSnap.exists()) {
                    console.log("Configuraci칩n no encontrada. Creando valores por defecto.");
                    await setDoc(configDocRef, DEFAULT_CONFIG);
                }
            } catch (error) {
                 console.error("Error al verificar/crear la configuraci칩n inicial:", error);
            }
        }

        /**
         * Configura el listener en tiempo real para la lista de tareas.
         */
        function setupRealtimeListener() {
            onSnapshot(configDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    renderApp(data);
                } else {
                    // Esto solo deber칤a ocurrir si el documento es eliminado. Reiniciar.
                    checkAndSetInitialConfig();
                }
            }, (error) => {
                console.error("Error en la escucha en tiempo real:", error);
            });
        }

        // ----------------------------------------------------
        // 3. FUNCIONES DE RENDERIZADO Y L칍GICA DE NEGOCIO
        // ----------------------------------------------------

        /**
         * Renderiza la aplicaci칩n completa con los datos de Firestore.
         * @param {Object} data - Los datos de la configuraci칩n (tasks, points, goal).
         */
        function renderApp(data) {
            const { tasks, current_points, reward_goal, reward_name } = data;
            
            // --- 1. RENDERIZAR PROGRESI칍N ---
            const progressPercentage = Math.min(100, (current_points / reward_goal) * 100);
            elements.progressBar.style.width = `${progressPercentage}%`;
            elements.pointsDisplay.textContent = `${current_points} / ${reward_goal} puntos`;
            elements.rewardText.textContent = `Recompensa: ${reward_name}`;
            
            // --- 2. RENDERIZAR LISTA DE TAREAS ---
            elements.taskListContainer.innerHTML = '';
            
            if (tasks.length === 0) {
                elements.emptyListMessage.classList.remove('hidden');
            } else {
                elements.emptyListMessage.classList.add('hidden');
            }

            tasks.forEach(task => {
                // Notar: Si la tarea est치 en la lista, asumimos que NO est치 completada 
                // ya que el c칩digo ahora la elimina al completar.
                const isCompleted = false; 
                const taskDiv = document.createElement('div');
                taskDiv.className = `card flex items-center justify-between p-4 rounded-xl shadow-md transition-all ${isCompleted ? 'bg-mint-green/30 opacity-70' : 'bg-white hover:bg-gray-50'}`;
                
                // Bot칩n de eliminar (visible solo si isAdminMode es true)
                const deleteButtonHTML = `
                    <button data-task-id="${task.id}" 
                            class="task-delete-btn delete-btn p-1 ml-2 text-deep-rose hover:bg-red-100 rounded-full transition 
                            ${isAdminMode ? '' : 'hidden-by-admin'}" 
                            aria-label="Eliminar Tarea">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `;

                taskDiv.innerHTML = `
                    <div class="flex-1 min-w-0 mr-4">
                        <h4 class="font-semibold text-text-dark text-lg">${task.title}</h4>
                        <p class="text-sm text-text-dark/60">${task.timeframe}</p>
                        <p class="text-xs font-mono mt-1 text-deep-rose/80">
                            +${task.points} puntos
                        </p>
                    </div>
                    <div class="flex items-center space-x-2">
                        ${deleteButtonHTML}
                        <button data-task-id="${task.id}" data-task-points="${task.points}" 
                                class="complete-btn flex items-center justify-center w-10 h-10 rounded-full text-white font-bold 
                                bg-mint-green hover:bg-[#008080]">
                            <!-- Icono de Marcar/Completar (Ahora siempre ser치 un '+' o un check, dependiendo de lo que elija) -->
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>
                        </button>
                    </div>
                `;
                elements.taskListContainer.appendChild(taskDiv);
            });

            // Re-adjuntar listeners de botones
            document.querySelectorAll('.complete-btn').forEach(button => {
                button.removeEventListener('click', handleTaskToggle); // Prevenir duplicados
                button.addEventListener('click', handleTaskToggle);
            });

            document.querySelectorAll('.task-delete-btn').forEach(button => {
                button.removeEventListener('click', handleDeleteTask); 
                button.addEventListener('click', handleDeleteTask);
            });


            // --- 3. RENDERIZAR PANEL DE ADMIN ---
            if (elements.adminPanel.classList.contains('hidden') || isAdminMode) {
                elements.rewardGoalInput.value = reward_goal;
                elements.rewardTextInput.value = reward_name;
            }
        }

        /**
         * Alterna el estado de completado de una tarea, SUMA PUNTOS y la ELIMINA autom치ticamente.
         * @param {Event} event - Evento de click.
         */
        async function handleTaskToggle(event) {
            const button = event.currentTarget;
            const taskId = button.dataset.taskId;
            
            button.disabled = true; // Previene doble click

            try {
                // Obtener datos actuales del documento
                const docSnap = await getDoc(configDocRef);
                if (!docSnap.exists()) return;
                
                const data = docSnap.data();
                const currentTasks = data.tasks || [];
                let currentPoints = data.current_points;
                
                const taskToComplete = currentTasks.find(task => task.id === taskId);
                
                if (!taskToComplete) {
                    console.warn("Tarea no encontrada. Acci칩n omitida.");
                    return;
                }
                
                // 1. Sumar Puntos
                // Si la tarea ya estaba marcada como completed, no deber칤amos llegar aqu칤,
                // pero si por alguna raz칩n el usuario usa el bot칩n 'Reiniciar D칤a', puede que
                // tenga la propiedad 'completed: true' aunque se muestre pendiente.
                // Para simplificar, asumimos que si est치 en la lista, debe ser completada.
                const points = parseInt(taskToComplete.points || data.points_per_task_default);
                currentPoints += points;
                
                // 2. Eliminar la Tarea (filtra la tarea completada)
                const newTasks = currentTasks.filter(task => task.id !== taskId);
                
                // 3. Actualizar Firestore
                await updateDoc(configDocRef, {
                    tasks: newTasks,
                    current_points: currentPoints 
                });

            } catch (error) {
                console.error("Error al completar/eliminar la tarea y actualizar puntos:", error);
            } finally {
                button.disabled = false;
            }
        }

        /**
         * Elimina una tarea de la lista (solo accesible en modo admin).
         * @param {Event} event - Evento de click.
         */
        async function handleDeleteTask(event) {
            const taskId = event.currentTarget.dataset.taskId;
            
            if (!isAdminMode) {
                console.warn("Intento de eliminar tarea sin modo admin activo.");
                return;
            }

            try {
                const docSnap = await getDoc(configDocRef);
                if (!docSnap.exists()) return;
                
                const data = docSnap.data();
                const currentTasks = data.tasks || [];
                
                // Filtra la tarea a eliminar
                const taskToDelete = currentTasks.find(t => t.id === taskId);
                const newTasks = currentTasks.filter(t => t.id !== taskId);

                // IMPORTANTE: Si se elimina desde el panel Admin, y la tarea hab칤a sido 
                // completada y luego reiniciada, NO restamos puntos.
                // Sin embargo, si la tarea ten칤a 'completed: true' y la eliminamos, 
                // deber칤a restarse si queremos ser rigurosos.
                // Dado que ahora la funci칩n 'handleTaskToggle' se encarga de sumar y borrar, 
                // esta funci칩n de Admin solo deber칤a usarse para *eliminar sin sumar puntos*.
                
                await updateDoc(configDocRef, {
                    tasks: newTasks,
                    // current_points se queda igual, solo se modifica en handleTaskToggle
                });

            } catch (error) {
                console.error("Error al eliminar la tarea:", error);
            }
        }

        // ----------------------------------------------------
        // 4. L칍GICA DE SEGURIDAD Y ADMINISTRACI칍N
        // ----------------------------------------------------

        /**
         * Muestra/Oculta el panel de administraci칩n con verificaci칩n de contrase침a.
         */
        function toggleAdminPanel(show) {
            if (show) {
                // Si est치 oculto y queremos mostrarlo, reiniciamos el modal y lo mostramos
                elements.adminPasswordInput.value = '';
                elements.passwordError.classList.add('hidden');
                elements.passwordModal.classList.remove('hidden');
                elements.adminPasswordInput.focus();
            } else {
                // Si est치 visible o queremos ocultarlo (tras fallo/cancelar)
                isAdminMode = false;
                elements.adminPanel.classList.add('hidden');
                elements.adminToggleBtn.textContent = 'Modo Admin';
                // Ocultar botones de eliminar para todos
                document.querySelectorAll('.task-delete-btn').forEach(btn => btn.classList.add('hidden-by-admin'));
            }
        }

        /**
         * Maneja la activaci칩n del modo Admin.
         */
        function activateAdminMode() {
            isAdminMode = true;
            elements.passwordModal.classList.add('hidden');
            elements.adminPanel.classList.remove('hidden');
            elements.adminToggleBtn.textContent = 'Ocultar Admin';
            elements.passwordError.classList.add('hidden');
            // Mostrar botones de eliminar solo al admin
            document.querySelectorAll('.task-delete-btn').forEach(btn => btn.classList.remove('hidden-by-admin'));
            // Refrescar inputs de configuraci칩n
            getDoc(configDocRef).then(docSnap => {
                if(docSnap.exists()){
                    const data = docSnap.data();
                    elements.rewardGoalInput.value = data.reward_goal;
                    elements.rewardTextInput.value = data.reward_name;
                }
            });
        }


        /**
         * Listener principal para el bot칩n Modo Admin.
         */
        elements.adminToggleBtn.addEventListener('click', () => {
            const isCurrentlyVisible = !elements.adminPanel.classList.contains('hidden');
            
            if (!isCurrentlyVisible) {
                toggleAdminPanel(true); // Mostrar modal de contrase침a
            } else {
                toggleAdminPanel(false); // Ocultar panel sin contrase침a
            }
        });

        /**
         * Maneja el env칤o del formulario de contrase침a.
         */
        elements.passwordForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const inputPassword = elements.adminPasswordInput.value;

            if (inputPassword === ADMIN_PASSWORD) {
                activateAdminMode();
            } else {
                // Contrase침a incorrecta
                elements.passwordError.classList.remove('hidden');
                elements.adminPasswordInput.value = '';
                elements.adminPasswordInput.focus();
            }
        });

        /**
         * Maneja el bot칩n Cancelar en el modal de contrase침a.
         */
        elements.cancelPasswordBtn.addEventListener('click', () => {
            elements.passwordModal.classList.add('hidden');
            elements.passwordError.classList.add('hidden');
        });

        /**
         * Maneja la adici칩n de una nueva tarea.
         */
        elements.addTaskForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const title = elements.newTaskTitle.value.trim();
            const timeframe = elements.newTaskTimeframe.value.trim() || 'Sin Marco Temporal';
            const points = parseInt(elements.newTaskPoints.value);

            if (!title || isNaN(points) || points <= 0) {
                console.error("Por favor, introduce un t칤tulo y puntos v치lidos (> 0).");
                return;
            }

            const newTask = {
                id: crypto.randomUUID(),
                title,
                timeframe,
                points,
                completed: false
            };

            try {
                const docSnap = await getDoc(configDocRef);
                if (!docSnap.exists()) return;
                
                const currentTasks = docSnap.data().tasks || [];
                
                await updateDoc(configDocRef, {
                    tasks: [...currentTasks, newTask]
                });

                elements.newTaskTitle.value = '';
                elements.newTaskTimeframe.value = '';
                elements.newTaskPoints.value = DEFAULT_CONFIG.points_per_task_default; // Resetear a valor por defecto

            } catch (error) {
                console.error("Error al a침adir tarea:", error);
            }
        });

        /**
         * Maneja la actualizaci칩n de la meta y el nombre de la recompensa.
         */
        elements.updateGoalBtn.addEventListener('click', async () => {
            const newGoal = parseInt(elements.rewardGoalInput.value);
            const newRewardName = elements.rewardTextInput.value.trim();

            if (isNaN(newGoal) || newGoal <= 0 || !newRewardName) {
                console.error("Por favor, introduce una meta de puntos v치lida y un nombre de recompensa.");
                return;
            }

            try {
                await updateDoc(configDocRef, {
                    reward_goal: newGoal,
                    reward_name: newRewardName
                });
                console.log("Meta y recompensa actualizadas correctamente.");
            } catch (error) {
                console.error("Error al actualizar la meta:", error);
            }
        });

        /**
         * Reinicia todas las tareas a pendientes para un nuevo ciclo (D칤a/Semana).
         */
        elements.resetDayBtn.addEventListener('click', async () => {
            if (!isAdminMode) return;
            
            try {
                const docSnap = await getDoc(configDocRef);
                if (!docSnap.exists()) return;

                const data = docSnap.data();
                const currentTasks = data.tasks || [];

                // Mapear y cambiar 'completed' a false para todas las tareas.
                // NOTA: Si deseas que las tareas se queden, pero se borren los puntos, 
                // tendr칤as que cambiar la l칩gica de puntos aqu칤. 
                // Pero como has pedido que se borren al completar, el bot칩n de 'Reiniciar D칤a' 
                // solo resetea el estado 'completed' (aunque ahora es menos relevante) 
                // para las tareas que hayan sido *agregadas* pero no completadas.
                const newTasks = currentTasks.map(task => ({
                    ...task,
                    completed: false
                }));

                await updateDoc(configDocRef, {
                    tasks: newTasks
                    // current_points NO se resetean, se mantienen para el progreso de recompensa
                });
                console.log("D칤a reiniciado. Tareas marcadas como pendientes.");

            } catch (error) {
                console.error("Error al reiniciar el d칤a:", error);
            }
        });


        // ----------------------------------------------------
        // 5. INICIALIZACI칍N
        // ----------------------------------------------------
        if (FIREBASE_CONFIG.projectId) {
            initializeFirebase();
        } else {
             console.error("ERROR: FIREBASE_CONFIG no est치 definida. Revisa si copiaste la configuraci칩n correctamente.");
             elements.loadingScreen.innerHTML = '<p class="text-red-600">Error de configuraci칩n de Firebase. Revisa la consola.</p>';
        }

    </script>
</body>
</html>
